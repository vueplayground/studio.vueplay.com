import{S as m}from"./SectionRenderer-8a22f1b2.js";import{S as v,A as g,s as c}from"./ast-468b170c.js";import{_ as w,r as p,c as y,j as _,l as b,a as I,g as S,d as F,o as f,v as j}from"./index-e32a8809.js";import"./compiler-bd304dde.js";const L={props:["path"],inject:["io","fs","account","packer","compiler","broadcaster"],components:{SectionRenderer:m,SectionFiles:v},data:()=>({loaded:!1,renderKey:0,fsItem:null,ast:new g,route:"/"}),watch:{"account.main"(e){this.ast.parse(e)},async fsItem(e,a){if(e!=null&&e.path.endsWith(".vue")){this.account.filepath=e.path;try{this.account.main=await this.fs.readFile(e.path,{encoding:"utf8"}),a||(this.layers="component")}catch{this.account.main=""}}}},async created(){var e,a;if(this.route=this.path,this.broadcaster.onmessage=async t=>{var i,o,s,n,r,d,l,h;if(!((i=t.data)!=null&&i.id)!==((n=(s=(o=this.account)==null?void 0:o.project)==null?void 0:s.data)==null?void 0:n._id))if(t.data.reload&&await this.reload(),(r=this.fsItem)!=null&&r.path.endsWith(".vue")&&((d=this.fsItem)==null?void 0:d.path)===((l=t.data)==null?void 0:l.path))try{this.account.main=await this.fs.readFile(this.fsItem.path,{encoding:"utf8"})}catch(u){console.log(u)}else(h=t.data)!=null&&h.path&&await this.reload()},this.account.filepath&&((e=this.account)==null?void 0:e.filepath)!==((a=this.fsItem)==null?void 0:a.path)){let t=this.account.filepath.split("/");try{let i=await this.fs.stat(this.account.filepath);this.fsItem={title:t[t.length-1],path:this.account.filepath,...i}}catch{this.fsItem=null}}},async mounted(){c.listen(t=>{t.event==="route"&&(this.route=t.path,window.history.pushState("object or string","Title","/live-preview"+this.route))});let e=await this.getFaviconPath(),a=await this.loadFavicon("/public/"+e);if(a){let t=document.querySelector("link[rel~='icon']");t||(t=document.createElement("link"),t.rel="icon",document.head.appendChild(t)),t.href=a}},methods:{go(e){c.send({event:"go",path:e}),setTimeout(()=>{c.send({event:"go",path:e})},100),setTimeout(()=>{c.send({event:"go",path:e})},200),setTimeout(()=>{c.send({event:"go",path:e})},300),setTimeout(()=>{c.send({event:"go",path:e})},400),setTimeout(()=>{c.send({event:"go",path:e})},500)},async reload(){var e;try{await this.fs.stat((e=this.fsItem)==null?void 0:e.path),this.account.main=await this.fs.readFile(this.fsItem.path,{encoding:"utf8"}),this.ast.parse(this.account.main)}catch{}this.renderKey++},async loadFavicon(e="/public/favicon.ico"){let a=["jpg","jpeg","gif","png","apng","avif","svg","webp","ico"];for await(const t of a)if(e.toLowerCase().endsWith(t)){let i=await this.fs.readFile(e),o="image/"+t.replace("jpg","jpeg").replace("svg","svg+xml");return URL.createObjectURL(new Blob([i],{type:o}))}return""},async getFaviconPath(e="/index.html"){let a="",t=await this.fs.readFile(e,{encoding:"utf8"}),i=URL.createObjectURL(new Blob([t],{type:"text/html"}));return await new Promise(o=>{let s=document.createElement("iframe");s.setAttribute("src",i),s.addEventListener("load",()=>{var r;let n=s.contentDocument.querySelector("link[rel~='icon']");a=((r=n==null?void 0:n.href)==null?void 0:r.replace(/^.*[\\\/]/,""))||"",s.remove(),o()}),document.body.appendChild(s)}),a}}},k={class:"preview"};function P(e,a,t,i,o,s){var d;const n=p("SectionRenderer"),r=p("SectionFiles");return f(),y("div",k,[_(n,{path:(d=e.fsItem)==null?void 0:d.path,ast:e.ast.root,main:s.account.main,sidemenu:"0px",mobile:!1,events:!0,full:!0,renderKey:e.renderKey,onInit:a[0]||(a[0]=l=>e.renderKey++),onLoaded:a[1]||(a[1]=l=>s.go(e.route))},null,8,["path","ast","main","renderKey"]),b(I("div",null,[e.loaded?F("",!0):(f(),S(r,{key:0,selected:e.fsItem,onSelected:a[2]||(a[2]=l=>(e.fsItem=l,e.loaded=!0))},null,8,["selected"]))],512),[[j,!1]])])}const C=w(L,[["render",P],["__scopeId","data-v-1db55923"]]);export{C as default};
