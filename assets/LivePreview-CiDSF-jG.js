import{S as m,l as v}from"./SectionRenderer-BNopeSzg.js";import{S as w,A as g,s as r}from"./ast-DbIeiLCF.js";import{_ as y,c as b,f as I,w as F,a as S,g as j,b as k,r as p,o as f,v as L}from"./index-C1Y3Fwq0.js";import"./compiler-DouLJUsY.js";const R={props:["path"],inject:["io","fs","account","packer","compiler","broadcaster"],components:{SectionRenderer:m,SectionFiles:w},data:()=>({loaded:!1,renderKey:0,fsItem:null,ast:new g,route:"/"}),watch:{"account.main"(e){this.ast.parse(e)},async fsItem(e,t){if(e!=null&&e.path.endsWith(".vue")){this.account.filepath=e.path;try{this.account.main=await this.fs.readFile(e.path,{encoding:"utf8"}),t||(this.layers="component")}catch{this.account.main=""}}}},async created(){var e,t;if(this.route=this.path,this.broadcaster.onmessage=async a=>{var s,c,l,i,n,o,d,h;if(!((s=a.data)!=null&&s.id)!==((i=(l=(c=this.account)==null?void 0:c.project)==null?void 0:l.data)==null?void 0:i.id))if(a.data.reload&&await this.reload(),(n=this.fsItem)!=null&&n.path.endsWith(".vue")&&((o=this.fsItem)==null?void 0:o.path)===((d=a.data)==null?void 0:d.path))try{this.account.main=await this.fs.readFile(this.fsItem.path,{encoding:"utf8"})}catch(u){console.log(u)}else(h=a.data)!=null&&h.path&&await this.reload()},this.account.filepath&&((e=this.account)==null?void 0:e.filepath)!==((t=this.fsItem)==null?void 0:t.path)){let a=this.account.filepath.split("/");try{let s=await this.fs.stat(this.account.filepath);this.fsItem={title:a[a.length-1],path:this.account.filepath,...s}}catch{this.fsItem=null}}},async mounted(){r.listen(async e=>{if(e.event==="route")this.route=e.path,window.history.pushState("object or string","Title","/live-preview"+this.route);else if(e.event==="load"){const t=await v(e.currentPath,e.path,e.reload,e.escape);r.send({event:"loaded-path",path:t,id:e.id})}}),await this.updateFavicon()},methods:{async updateFavicon(){let e=await this.getMeta(),t=await this.loadFavicon("/public/"+e.filename);if(t){let a=document.querySelector("link[rel~='icon']");a||(a=document.createElement("link"),a.rel="icon",document.head.appendChild(a)),a.href=t}e.title&&(document.title=e.title+" [Preview]")},go(e){r.send({event:"go",path:e}),setTimeout(()=>{r.send({event:"go",path:e})},100),setTimeout(()=>{r.send({event:"go",path:e})},200),setTimeout(()=>{r.send({event:"go",path:e})},300),setTimeout(()=>{r.send({event:"go",path:e})},400),setTimeout(()=>{r.send({event:"go",path:e})},500)},async reload(){var e;try{await this.fs.stat((e=this.fsItem)==null?void 0:e.path),this.account.main=await this.fs.readFile(this.fsItem.path,{encoding:"utf8"}),this.ast.parse(this.account.main),await this.updateFavicon()}catch{}this.renderKey++},async loadFavicon(e="/public/favicon.ico"){let t=["jpg","jpeg","gif","png","apng","avif","svg","webp","ico"];for await(const a of t)if(e.toLowerCase().endsWith(a)){let s=await this.fs.readFile(e),c="image/"+a.replace("jpg","jpeg").replace("svg","svg+xml");return URL.createObjectURL(new Blob([s],{type:c}))}return""},async getMeta(e="/index.html"){let t="",a="",s=await this.fs.readFile(e,{encoding:"utf8"}),c=URL.createObjectURL(new Blob([s],{type:"text/html"}));return await new Promise(l=>{let i=document.createElement("iframe");i.setAttribute("src",c),i.addEventListener("load",()=>{var o;let n=i.contentDocument.querySelector("link[rel~='icon']");t=((o=n==null?void 0:n.getAttribute("href"))==null?void 0:o.replace(/^.*[\\\/]/,""))||"",a=i.contentDocument.title,i.remove(),l()}),document.body.appendChild(i)}),{filename:t,title:a}}}},B={class:"preview"};function K(e,t,a,s,c,l){var o;const i=p("SectionRenderer"),n=p("SectionFiles");return f(),b("div",B,[I(i,{path:(o=e.fsItem)==null?void 0:o.path,ast:e.ast.root,main:l.account.main,sidemenu:"0px",mobile:!1,events:!0,full:!0,renderKey:e.renderKey,onInit:t[0]||(t[0]=d=>e.renderKey++),onLoaded:t[1]||(t[1]=d=>l.go(e.route))},null,8,["path","ast","main","renderKey"]),F(S("div",null,[e.loaded?k("",!0):(f(),j(n,{key:0,selected:e.fsItem,onSelected:t[2]||(t[2]=d=>(e.fsItem=d,e.loaded=!0))},null,8,["selected"]))],512),[[L,!1]])])}const P=y(R,[["render",K],["__scopeId","data-v-104d0b22"]]);export{P as default};
