import{S as m,l as v}from"./SectionRenderer-193e7635.js";import{S as g,A as w,s as r}from"./ast-aa939e3e.js";import{_ as y,r as p,c as _,j as I,l as b,a as F,g as S,d as j,o as u,v as L}from"./index-5e8e59e5.js";import"./compiler-0f72adde.js";const k={props:["path"],inject:["io","fs","account","packer","compiler","broadcaster"],components:{SectionRenderer:m,SectionFiles:g},data:()=>({loaded:!1,renderKey:0,fsItem:null,ast:new w,route:"/"}),watch:{"account.main"(e){this.ast.parse(e)},async fsItem(e,t){if(e!=null&&e.path.endsWith(".vue")){this.account.filepath=e.path;try{this.account.main=await this.fs.readFile(e.path,{encoding:"utf8"}),t||(this.layers="component")}catch{this.account.main=""}}}},async created(){var e,t;if(this.route=this.path,this.broadcaster.onmessage=async a=>{var n,c,l,i,s,o,d,h;if(!((n=a.data)!=null&&n.id)!==((i=(l=(c=this.account)==null?void 0:c.project)==null?void 0:l.data)==null?void 0:i._id))if(a.data.reload&&await this.reload(),(s=this.fsItem)!=null&&s.path.endsWith(".vue")&&((o=this.fsItem)==null?void 0:o.path)===((d=a.data)==null?void 0:d.path))try{this.account.main=await this.fs.readFile(this.fsItem.path,{encoding:"utf8"})}catch(f){console.log(f)}else(h=a.data)!=null&&h.path&&await this.reload()},this.account.filepath&&((e=this.account)==null?void 0:e.filepath)!==((t=this.fsItem)==null?void 0:t.path)){let a=this.account.filepath.split("/");try{let n=await this.fs.stat(this.account.filepath);this.fsItem={title:a[a.length-1],path:this.account.filepath,...n}}catch{this.fsItem=null}}},async mounted(){r.listen(async e=>{if(e.event==="route")this.route=e.path,window.history.pushState("object or string","Title","/live-preview"+this.route);else if(e.event==="load"){const t=await v(e.currentPath,e.path,e.reload,e.escape);r.send({event:"loaded-path",path:t,id:e.id})}}),await this.updateFavicon()},methods:{async updateFavicon(){let e=await this.getMeta(),t=await this.loadFavicon("/public/"+e.filename);if(t){let a=document.querySelector("link[rel~='icon']");a||(a=document.createElement("link"),a.rel="icon",document.head.appendChild(a)),a.href=t}e.title&&(document.title=e.title+" [Preview]")},go(e){r.send({event:"go",path:e}),setTimeout(()=>{r.send({event:"go",path:e})},100),setTimeout(()=>{r.send({event:"go",path:e})},200),setTimeout(()=>{r.send({event:"go",path:e})},300),setTimeout(()=>{r.send({event:"go",path:e})},400),setTimeout(()=>{r.send({event:"go",path:e})},500)},async reload(){var e;try{await this.fs.stat((e=this.fsItem)==null?void 0:e.path),this.account.main=await this.fs.readFile(this.fsItem.path,{encoding:"utf8"}),this.ast.parse(this.account.main),await this.updateFavicon()}catch{}this.renderKey++},async loadFavicon(e="/public/favicon.ico"){let t=["jpg","jpeg","gif","png","apng","avif","svg","webp","ico"];for await(const a of t)if(e.toLowerCase().endsWith(a)){let n=await this.fs.readFile(e),c="image/"+a.replace("jpg","jpeg").replace("svg","svg+xml");return URL.createObjectURL(new Blob([n],{type:c}))}return""},async getMeta(e="/index.html"){let t="",a="",n=await this.fs.readFile(e,{encoding:"utf8"}),c=URL.createObjectURL(new Blob([n],{type:"text/html"}));return await new Promise(l=>{let i=document.createElement("iframe");i.setAttribute("src",c),i.addEventListener("load",()=>{var o;let s=i.contentDocument.querySelector("link[rel~='icon']");t=((o=s==null?void 0:s.getAttribute("href"))==null?void 0:o.replace(/^.*[\\\/]/,""))||"",a=i.contentDocument.title,i.remove(),l()}),document.body.appendChild(i)}),{filename:t,title:a}}}},R={class:"preview"};function B(e,t,a,n,c,l){var o;const i=p("SectionRenderer"),s=p("SectionFiles");return u(),_("div",R,[I(i,{path:(o=e.fsItem)==null?void 0:o.path,ast:e.ast.root,main:l.account.main,sidemenu:"0px",mobile:!1,events:!0,full:!0,renderKey:e.renderKey,onInit:t[0]||(t[0]=d=>e.renderKey++),onLoaded:t[1]||(t[1]=d=>l.go(e.route))},null,8,["path","ast","main","renderKey"]),b(F("div",null,[e.loaded?j("",!0):(u(),S(s,{key:0,selected:e.fsItem,onSelected:t[2]||(t[2]=d=>(e.fsItem=d,e.loaded=!0))},null,8,["selected"]))],512),[[L,!1]])])}const A=y(k,[["render",B],["__scopeId","data-v-238e03ad"]]);export{A as default};
