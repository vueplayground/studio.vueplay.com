import{S as m}from"./SectionRenderer-c696dc12.js";import{S as v,A as g,s as l}from"./ast-17a3e0eb.js";import{_ as w,r as p,c as y,j as _,l as I,a as b,g as F,d as S,o as u,v as j}from"./index-c08e39eb.js";import"./compiler-29fde4ac.js";const L={props:["path"],inject:["io","fs","account","packer","compiler","broadcaster"],components:{SectionRenderer:m,SectionFiles:v},data:()=>({loaded:!1,renderKey:0,fsItem:null,ast:new g,route:"/"}),watch:{"account.main"(e){this.ast.parse(e)},async fsItem(e,a){if(e!=null&&e.path.endsWith(".vue")){this.account.filepath=e.path;try{this.account.main=await this.fs.readFile(e.path,{encoding:"utf8"}),a||(this.layers="component")}catch{this.account.main=""}}}},async created(){var e,a;if(this.route=this.path,this.broadcaster.onmessage=async t=>{var n,r,c,i,s,o,d,h;if(!((n=t.data)!=null&&n.id)!==((i=(c=(r=this.account)==null?void 0:r.project)==null?void 0:c.data)==null?void 0:i._id))if(t.data.reload&&await this.reload(),(s=this.fsItem)!=null&&s.path.endsWith(".vue")&&((o=this.fsItem)==null?void 0:o.path)===((d=t.data)==null?void 0:d.path))try{this.account.main=await this.fs.readFile(this.fsItem.path,{encoding:"utf8"})}catch(f){console.log(f)}else(h=t.data)!=null&&h.path&&await this.reload()},this.account.filepath&&((e=this.account)==null?void 0:e.filepath)!==((a=this.fsItem)==null?void 0:a.path)){let t=this.account.filepath.split("/");try{let n=await this.fs.stat(this.account.filepath);this.fsItem={title:t[t.length-1],path:this.account.filepath,...n}}catch{this.fsItem=null}}},async mounted(){l.listen(e=>{e.event==="route"&&(this.route=e.path,window.history.pushState("object or string","Title","/live-preview"+this.route))}),await this.updateFavicon()},methods:{async updateFavicon(){let e=await this.getMeta(),a=await this.loadFavicon("/public/"+e.filename);if(a){let t=document.querySelector("link[rel~='icon']");t||(t=document.createElement("link"),t.rel="icon",document.head.appendChild(t)),t.href=a}e.title&&(document.title=e.title+" [Preview]")},go(e){l.send({event:"go",path:e}),setTimeout(()=>{l.send({event:"go",path:e})},100),setTimeout(()=>{l.send({event:"go",path:e})},200),setTimeout(()=>{l.send({event:"go",path:e})},300),setTimeout(()=>{l.send({event:"go",path:e})},400),setTimeout(()=>{l.send({event:"go",path:e})},500)},async reload(){var e;try{await this.fs.stat((e=this.fsItem)==null?void 0:e.path),this.account.main=await this.fs.readFile(this.fsItem.path,{encoding:"utf8"}),this.ast.parse(this.account.main),await this.updateFavicon()}catch{}this.renderKey++},async loadFavicon(e="/public/favicon.ico"){let a=["jpg","jpeg","gif","png","apng","avif","svg","webp","ico"];for await(const t of a)if(e.toLowerCase().endsWith(t)){let n=await this.fs.readFile(e),r="image/"+t.replace("jpg","jpeg").replace("svg","svg+xml");return URL.createObjectURL(new Blob([n],{type:r}))}return""},async getMeta(e="/index.html"){let a="",t="",n=await this.fs.readFile(e,{encoding:"utf8"}),r=URL.createObjectURL(new Blob([n],{type:"text/html"}));return await new Promise(c=>{let i=document.createElement("iframe");i.setAttribute("src",r),i.addEventListener("load",()=>{var o;let s=i.contentDocument.querySelector("link[rel~='icon']");a=((o=s==null?void 0:s.getAttribute("href"))==null?void 0:o.replace(/^.*[\\\/]/,""))||"",t=i.contentDocument.title,i.remove(),c()}),document.body.appendChild(i)}),{filename:a,title:t}}}},k={class:"preview"};function R(e,a,t,n,r,c){var o;const i=p("SectionRenderer"),s=p("SectionFiles");return u(),y("div",k,[_(i,{path:(o=e.fsItem)==null?void 0:o.path,ast:e.ast.root,main:c.account.main,sidemenu:"0px",mobile:!1,events:!0,full:!0,renderKey:e.renderKey,onInit:a[0]||(a[0]=d=>e.renderKey++),onLoaded:a[1]||(a[1]=d=>c.go(e.route))},null,8,["path","ast","main","renderKey"]),I(b("div",null,[e.loaded?S("",!0):(u(),F(s,{key:0,selected:e.fsItem,onSelected:a[2]||(a[2]=d=>(e.fsItem=d,e.loaded=!0))},null,8,["selected"]))],512),[[j,!1]])])}const P=w(L,[["render",R],["__scopeId","data-v-3a326933"]]);export{P as default};
