import{S as m}from"./SectionRenderer-d34a418d.js";import{S as v,A as g,s as c}from"./ast-5aa615c1.js";import{_ as w,r as p,c as y,j as _,l as F,a as b,g as I,d as S,o as u,v as j}from"./index-894cdb74.js";import"./compiler-d78af002.js";const L={props:["path"],inject:["io","fs","account","packer","compiler","broadcaster"],components:{SectionRenderer:m,SectionFiles:v},data:()=>({loaded:!1,renderKey:0,fsItem:null,ast:new g,route:"/"}),watch:{"account.main"(e){this.ast.parse(e)},async fsItem(e,t){if(e!=null&&e.path.endsWith(".vue")){this.account.filepath=e.path;try{this.account.main=await this.fs.readFile(e.path,{encoding:"utf8"}),t||(this.layers="component")}catch{this.account.main=""}}}},async created(){var e,t;if(this.route=this.path,this.broadcaster.onmessage=async a=>{var s,o,i,n,r,d,l,h;if(!((s=a.data)!=null&&s.id)!==((n=(i=(o=this.account)==null?void 0:o.project)==null?void 0:i.data)==null?void 0:n._id))if(a.data.reload&&await this.reload(),(r=this.fsItem)!=null&&r.path.endsWith(".vue")&&((d=this.fsItem)==null?void 0:d.path)===((l=a.data)==null?void 0:l.path))try{this.account.main=await this.fs.readFile(this.fsItem.path,{encoding:"utf8"})}catch(f){console.log(f)}else(h=a.data)!=null&&h.path&&await this.reload()},this.account.filepath&&((e=this.account)==null?void 0:e.filepath)!==((t=this.fsItem)==null?void 0:t.path)){let a=this.account.filepath.split("/");try{let s=await this.fs.stat(this.account.filepath);this.fsItem={title:a[a.length-1],path:this.account.filepath,...s}}catch{this.fsItem=null}}},async mounted(){c.listen(e=>{e.event==="route"&&(this.route=e.path,window.history.pushState("object or string","Title","/live-preview"+this.route))}),await this.updateFavicon()},methods:{async updateFavicon(){let e=await this.getFaviconFileName(),t=await this.loadFavicon("/public/"+e);if(t){let a=document.querySelector("link[rel~='icon']");a||(a=document.createElement("link"),a.rel="icon",document.head.appendChild(a)),a.href=t}},go(e){c.send({event:"go",path:e}),setTimeout(()=>{c.send({event:"go",path:e})},100),setTimeout(()=>{c.send({event:"go",path:e})},200),setTimeout(()=>{c.send({event:"go",path:e})},300),setTimeout(()=>{c.send({event:"go",path:e})},400),setTimeout(()=>{c.send({event:"go",path:e})},500)},async reload(){var e;try{await this.fs.stat((e=this.fsItem)==null?void 0:e.path),this.account.main=await this.fs.readFile(this.fsItem.path,{encoding:"utf8"}),this.ast.parse(this.account.main),await this.updateFavicon()}catch{}this.renderKey++},async loadFavicon(e="/public/favicon.ico"){let t=["jpg","jpeg","gif","png","apng","avif","svg","webp","ico"];for await(const a of t)if(e.toLowerCase().endsWith(a)){let s=await this.fs.readFile(e),o="image/"+a.replace("jpg","jpeg").replace("svg","svg+xml");return URL.createObjectURL(new Blob([s],{type:o}))}return""},async getFaviconFileName(e="/index.html"){let t="",a=await this.fs.readFile(e,{encoding:"utf8"}),s=URL.createObjectURL(new Blob([a],{type:"text/html"}));return await new Promise(o=>{let i=document.createElement("iframe");i.setAttribute("src",s),i.addEventListener("load",()=>{var r;let n=i.contentDocument.querySelector("link[rel~='icon']");t=((r=n==null?void 0:n.href)==null?void 0:r.replace(/^.*[\\\/]/,""))||"",i.remove(),o()}),document.body.appendChild(i)}),t}}},k={class:"preview"};function R(e,t,a,s,o,i){var d;const n=p("SectionRenderer"),r=p("SectionFiles");return u(),y("div",k,[_(n,{path:(d=e.fsItem)==null?void 0:d.path,ast:e.ast.root,main:i.account.main,sidemenu:"0px",mobile:!1,events:!0,full:!0,renderKey:e.renderKey,onInit:t[0]||(t[0]=l=>e.renderKey++),onLoaded:t[1]||(t[1]=l=>i.go(e.route))},null,8,["path","ast","main","renderKey"]),F(b("div",null,[e.loaded?S("",!0):(u(),I(r,{key:0,selected:e.fsItem,onSelected:t[2]||(t[2]=l=>(e.fsItem=l,e.loaded=!0))},null,8,["selected"]))],512),[[j,!1]])])}const N=w(L,[["render",R],["__scopeId","data-v-d72b5efa"]]);export{N as default};
